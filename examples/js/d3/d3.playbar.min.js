/*exported playbar*//*global d3,spinner*//**
* d3 playbar widget
* @param (object) args
* @returns playbar object
*/function playbar(e){function m(e){y.status(r.status);d=e;e.each(function(){var e=d3.select(this);e.attr("class","playbar");var t=e.append("g").attr("class","container").attr("transform","translate(0,"+r.graph_padding+")"),n=t.append("g").attr("class","background_container");n.append("rect").attr("class","background button").attr("x",0).attr("y",0).on("click",m.togglePlayer).attr("height",r.button_height).attr("width",r.button_width);n.append("rect").attr("class","background playbar").attr("x",r.button_width+r.button_margin).attr("y",0).attr("height",r.bar_height);var f=t.append("g").attr("class","data_background_container").attr("transform","translate("+(r.button_width+r.button_margin+1)+",0)");f.append("path").attr("transform","translate(0, "+(r.graph_padding-1)+")").attr("class","area inactive");f.append("g").attr("class","x axis").attr("transform","translate(-1,"+(r.height-r.axis_height-r.graph_padding*2+2*r.border_width)+")");f.append("g").attr("class","y axis");var l=t.append("g").attr("class","data_foreground_container").attr("transform","translate("+(r.button_width+r.button_margin+1)+",0)"),c=m.randomID();l.append("path").attr("transform","translate(0, "+(r.graph_padding-.5)+")").attr("class","area active").attr("mask","url(#"+c+")").attr("clip-path","url(#"+c+")");l.append("defs").append("clipPath").attr("class","clip").attr("id",c).append("rect").attr("transform","translate(0,0)").attr("height",r.bar_height);var h=t.append("g").attr("class","icon_container loading");h.append("path").attr("class","icon play").attr("d",u(i)).on("click",m.togglePlayer);var p=h.append("g").attr("class","icon pause");p.append("path").attr("d",u(s)).on("click",m.togglePlayer);p.append("path").attr("d",u(o)).on("click",m.togglePlayer);var d=h.append("g").attr("class","icon spinner").attr("transform","translate("+r.graph_padding+","+r.graph_padding+")"),g=spinner({width:r.button_width-r.graph_padding*2,height:r.button_height-r.graph_padding*2});d.call(g);var y=t.append("g").attr("class","border_container");y.append("rect").attr("class","border button").attr("x",r.border_width/2).attr("y",r.border_width/2).attr("height",r.button_height-r.border_width).attr("width",r.button_width-r.border_width);y.append("rect").attr("class","border playbar").attr("x",r.button_width+r.button_margin).attr("y",r.border_width/2).attr("height",r.bar_height-r.border_width);y.append("g").attr("transform","translate("+(r.button_width+r.button_margin+1)+",1)").append("rect").attr("class","handle").attr("x",0).attr("height",r.bar_height-2).attr("width",1);var b=t.append("g").attr("class","brush_container");v=d3.svg.brush().x(a).extent([0,0]).on("brush",m.brushed);var w=b.append("g").attr("transform","translate("+(r.button_width+r.button_margin)+",0)").attr("class","slider").call(v);w.selectAll(".extent,.resize").remove();w.select(".background").attr("height",r.bar_height+r.graph_padding)});m.resize()}var t={height:77,button_width:50,axis_height:20,axis_width:50,button_margin:10,icon_size:50,graph_padding:5,border_width:1,repeat:!0,autoplay:!0,x_name:"date",x_type:"time",y_name:"price",bar_width:0,bar_height:0,button_height:0,icon_width:0,icon_height:0,data:!1,data_size:100,data_loaded:0,current:0,status:"loading",min_frame_load:20,speed:100},n=!1,r=d3.tools.extend(t,e);r.bar_height=r.height-2*r.border_width-r.graph_padding-r.axis_height;r.button_height=r.bar_height;r.icon_width=r.button_width/100*r.icon_size;r.icon_height=r.button_height/100*r.icon_size;var i=[{x:(r.button_width-r.icon_width)/2,y:(r.button_height-r.icon_height)/2},{x:(r.button_width-r.icon_width)/2,y:(r.button_height-r.icon_height)/2+r.icon_height},{x:(r.button_width-r.icon_width)/2+r.icon_width,y:(r.button_height-r.icon_height)/2+r.icon_height/2},{x:(r.button_width-r.icon_width)/2,y:(r.button_height-r.icon_height)/2}],s=[{x:(r.button_width-r.icon_width)/2,y:(r.button_height-r.icon_height)/2},{x:(r.button_width-r.icon_width)/2,y:(r.button_height-r.icon_height)/2+r.icon_height},{x:(r.button_width-r.icon_width)/2+r.icon_width/3,y:(r.button_height-r.icon_height)/2+r.icon_height},{x:(r.button_width-r.icon_width)/2+r.icon_width/3,y:(r.button_height-r.icon_height)/2},{x:(r.button_width-r.icon_width)/2,y:(r.button_height-r.icon_height)/2}],o=[{x:(r.button_width-r.icon_width)/2+r.icon_width/3*2,y:(r.button_height-r.icon_height)/2},{x:(r.button_width-r.icon_width)/2+r.icon_width/3*2,y:(r.button_height-r.icon_height)/2+r.icon_height},{x:(r.button_width-r.icon_width)/2+r.icon_width/3*3,y:(r.button_height-r.icon_height)/2+r.icon_height},{x:(r.button_width-r.icon_width)/2+r.icon_width/3*3,y:(r.button_height-r.icon_height)/2},{x:(r.button_width-r.icon_width)/2+r.icon_width/3*2,y:(r.button_height-r.icon_height)/2}],u=d3.svg.line().x(function(e){return e.x}).y(function(e){return e.y}).interpolate("linear");if(r.x_type=="time")var a=d3.time.scale().range([0,r.bar_width]);else var a=d3.scale.linear().range([0,r.bar_width]);var f=d3.svg.axis().scale(a).ticks(Math.floor(r.bar_width/50)).orient("bottom"),l=d3.scale.linear().range([r.bar_height-r.graph_padding,0]),c=d3.svg.axis().scale(l).ticks(3).orient("right"),h=d3.svg.area().interpolate("monotone").x(function(e){return a(e[r.x_name])}).y0(r.bar_height-r.graph_padding).y1(function(e){return l(e[r.y_name])}),p=d3.svg.area().interpolate("monotone").x(function(e){return a(e[r.x_name])}).y0(r.bar_height-r.graph_padding).y1(function(e){return l(e[r.y_name])}),d,v;m.randomID=function(){var e="",t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz123456789";for(var n=0;n<10;n++)e+=t.charAt(Math.floor(Math.random()*t.length));return e};m.resize=function(){d.each(function(){var e=d3.select(this),t=this.getBoundingClientRect().width;r.bar_width=t-r.button_margin-r.button_width-r.axis_width;e.select(".background.playbar").attr("width",r.bar_width);e.select(".clip rect").attr("width",r.bar_width/r.data_size*r.data_loaded);e.select(".border.playbar").attr("width",r.bar_width-r.border_width);if(r.data){r.x_type=="time"?a=d3.time.scale().range([0,r.bar_width-1]):a=d3.scale.linear().range([0,r.bar_width]);a.domain([d3.min(r.data.map(function(e){var t=e[r.x_name];r.x_type=="linear"&&(t=parseFloat(e[r.x_name]));return t})),d3.max(r.data.map(function(e){var t=e[r.x_name];r.x_type=="linear"&&(t=parseFloat(e[r.x_name]));return t}))]);f=d3.svg.axis().scale(a).ticks(Math.floor((r.bar_width-1)/50)).orient("bottom");v.x(a);e.select("path.area.active").datum(r.data).attr("d",h);e.select("path.area.inactive").datum(r.data).attr("d",p);e.select(".handle").attr("x",(r.bar_width-2)/r.data_size*r.current);e.select("g.x.axis").call(f);e.select("g.y.axis").attr("transform","translate("+(r.bar_width-2*r.border_width)+",0)");e.select("g.slider .background").attr("width",r.bar_width)}})};m.brushed=function(){var e=v.extent()[0];if(a(e)>0&&a(e)<r.bar_width&&a(e)/r.bar_width<r.data_loaded/r.data_size){r.current=Math.floor(a(e)/r.bar_width*r.data_size);d.each(function(){var e=d3.select(this);e.select(".handle").attr("x",(r.bar_width-2)/r.data_size*r.current)});r.status=="pause"&&y.change(r.current)}};m.togglePlayer=function(){d.each(function(){var e=d3.select(this),t=e.select(".icon_container");if(t.attr("class").indexOf("playing")>-1){r.status="pause";y.status(r.status);d3.tools.removeClass(t,"playing");d3.tools.addClass(t,"pause");if(n){clearInterval(n);n=!1}}else if(t.attr("class").indexOf("pause")>-1){r.status="playing";y.status(r.status);d3.tools.addClass(t,"playing");d3.tools.removeClass(t,"pause");n=setInterval(function(){m.play()},r.speed)}else{d3.tools.addClass(e,"loading");d3.tools.removeClass(t,"playing");d3.tools.removeClass(t,"pause")}})};m.enoughData=function(){d.each(function(){var e=d3.select(this),t=e.select(".icon_container");d3.tools.removeClass(t,"loading");if(r.autoplay){r.status="playing";d3.tools.addClass(t,"playing");d3.tools.removeClass(t,"pause")}else{r.status="pause";d3.tools.addClass(t,"pause");d3.tools.removeClass(t,"playing")}y.status(r.status);r.status==="playing"&&(n=setInterval(function(){m.play()},r.speed))})};m.play=function(){r.current++;r.current>r.data_loaded+1&&(r.current=r.data_loaded);if(r.current>r.data_size){r.current=0;if(!r.repeat){clearInterval(n);n=!1;d.each(function(){var e=d3.select(this),t=e.select(".icon_container");r.status="pause";y.status(r.status);d3.tools.removeClass(t,"playing");d3.tools.addClass(t,"pause")})}}d.each(function(){var e=d3.select(this);e.select(".handle").attr("x",(r.bar_width-2)/r.data_size*r.current)});y.change(r.current)};var g={timestamp:0,avrg_speed:0,avrg_size:0};m.loading=function(e,t){r.data_loaded=e;var n=new Date;g.timestamp===0&&(g.timestamp=n.getTime()-1);var i=t/(n.getTime()-g.timestamp);g.avrg_speed=(g.avrg_speed*r.data_loaded+i)/(r.data_loaded+1);g.avrg_size=(g.avrg_size*r.data_loaded+t)/(r.data_loaded+1);r.data_loaded>r.min_frame_load&&r.status==="loading"&&r.data_size*r.speed>(r.data_size-r.data_loaded)*g.avrg_speed*1.1&&m.enoughData();d.each(function(){d3.select(this).select(".clip rect").attr("width",r.bar_width/r.data_size*r.data_loaded)});r.data_loaded===r.data_size&&r.status==="loading"&&m.enoughData()};m.data=function(e){r.data=e;r.data_size=e.length;r.min_frame_load=e.length*.2;l.domain([d3.min(e.map(function(e){return e[r.y_name]})),d3.max(e.map(function(e){return e[r.y_name]}))]);d.each(function(){var t=d3.select(this);t.select("path.area.active").datum(e).attr("d",h);t.select("path.area.inactive").datum(e).attr("d",p);t.select("g.x.axis").call(f);t.select("g.y.axis").call(c)});m.resize()};d3.select(window).on("resize",function(){m.resize()});var y=d3.dispatch("change","status");d3.rebind(m,y,"on");return m};